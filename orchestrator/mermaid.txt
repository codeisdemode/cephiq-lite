graph TB
    %% User Input Layer
    A[ğŸ‘¤ User Input<br/>Natural language + commands] --> B[ğŸ’¬ Chat Interface<br/>chat_interface.py]
    B --> C[ğŸ¨ Rich Console UI<br/>Panels, Tables, Progress Bars]
    
    %% Session Management Layer
    B --> D[ğŸ’¾ Session Manager<br/>Multi-user, persistence]
    D --> DA[ğŸ†” Session Storage<br/>User preferences, state]
    D --> DB[ğŸ“Š Session Statistics<br/>Usage tracking, analytics]
    D --> DC[ğŸ” User Authentication<br/>Role-based permissions]
    
    %% Input Processing Layer
    B --> E[ğŸ¯ Input Processor<br/>Parse requests + commands]
    E --> EA[âŒ¨ï¸ Special Command Handler<br/>chat_commands.py]
    EA --> EAA[ğŸ“‹ Command Registry<br/>/help /status /clear /exit]
    EA --> EAB[ğŸ” Command Validation<br/>Interface-aware availability]
    EA --> EAC[âœ… Command Execution<br/>Cross-platform consistency]
    
    %% Policy & Security Layer
    E --> F[ğŸ›¡ï¸ Policy Guard<br/>policy_guard.py]
    F --> FA[âš ï¸ Danger Detection<br/>Destructive command patterns]
    F --> FB[ğŸ‘¥ Role Permissions<br/>User capability checking]
    F --> FC[ğŸ“ File Operation Safety<br/>Protected directory checks]
    F --> FD[âš¡ System Command Filtering<br/>Safe execution validation]
    
    %% Context Management Layer  
    F --> G[ğŸ”„ Chat-to-Pipeline Adapter<br/>Transform chat to envelope context]
    G --> H[ğŸ›ï¸ Context Builder<br/>Add conversation history]
    H --> HA[ğŸ“ Context Manager<br/>context_manager.py]
    HA --> HAA[ğŸ§  Smart History Management<br/>Topic-aware relevance scoring]
    HA --> HAB[ğŸ“Š Message Summarization<br/>Compress old conversations]
    HA --> HAC[ğŸ·ï¸ Topic Extraction<br/>Content categorization]
    HA --> HAD[âš–ï¸ Relevance Scoring<br/>Select optimal messages]
    
    %% Existing Backend - Unchanged
    HA --> I[ğŸ§  runner.py<br/>EXISTING - Main orchestration loop]
    I --> J[âš™ï¸ decide_next.py<br/>EXISTING - GPT-5 decision engine]
    J --> K[ğŸ“¦ Envelope Generation<br/>EXISTING - Validated JSON responses]
    K --> L[ğŸ”§ tools_stub.py<br/>EXISTING - Tool dispatcher]
    L --> M[âš™ï¸ combined_mcp_server.py<br/>EXISTING - MCP tool server]
    
    %% Results Processing Layer
    M --> N[ğŸ“Š Result Processor<br/>Handle envelope responses]
    N --> NA[âŒ Error Handler<br/>error_handler.py]
    NA --> NAA[ğŸ” Result Validation<br/>Check for valid responses]
    NA --> NAB[ğŸš¨ Error Classification<br/>Invalid envelope, timeout, etc]
    NA --> NAC[ğŸ’¡ Error Recovery<br/>User-friendly messages + suggestions]
    NA --> NAD[ğŸ› Debug Information<br/>Technical details for debug mode]
    
    N --> NB[âš¡ Async Task Manager<br/>async_task_manager.py]
    NB --> NBA[ğŸ”„ Background Tasks<br/>Long-running operations]
    NB --> NBB[ğŸ“Š Progress Tracking<br/>Real-time status updates]
    NB --> NBC[ğŸ”” Task Notifications<br/>Completion alerts]
    NB --> NBD[ğŸ“‹ Task Registry<br/>Active task management]
    
    %% Response Formatting Layer
    NA --> O[ğŸ¨ Rich Formatter<br/>chat_formatter.py]
    NB --> O
    O --> OA[ğŸ“‹ Envelope Result Formatting<br/>Tool outputs, messages, errors]
    O --> OB[ğŸ“Š Table Generation<br/>File lists, process info]
    O --> OC[ğŸ¨ Syntax Highlighting<br/>Code blocks, command output]
    O --> OD[ğŸ“ˆ Progress Visualization<br/>Task progress bars]
    
    %% Multiple Output Interfaces
    O --> P[ğŸ–¥ï¸ Rich CLI Interface<br/>Primary console output]
    P --> PA[ğŸ­ Interactive Panels<br/>Welcome, help, status]
    P --> PB[ğŸ“Š Dynamic Tables<br/>File listings, results]
    P --> PC[ğŸ¨ Colored Output<br/>Syntax highlighting]
    P --> PD[â³ Progress Indicators<br/>Real-time task updates]
    
    O --> Q[ğŸŒ Web Interface<br/>web_chat.py]
    Q --> QA[ğŸ“¡ WebSocket Streaming<br/>Real-time bidirectional communication]
    Q --> QB[ğŸ¨ Rich Web Components<br/>Interactive tables, charts]
    Q --> QC[ğŸ“± Responsive Design<br/>Mobile-friendly interface]
    Q --> QD[ğŸ”„ Real-time Updates<br/>Live task progress]
    
    O --> R[ğŸ“± API Interface<br/>api_interface.py]
    R --> RA[ğŸ“¦ Raw Envelope Output<br/>Direct pipeline responses]
    R --> RB[ğŸ¨ Formatted Responses<br/>Human-readable content]
    R --> RC[ğŸ“Š Structured Data<br/>Machine-processable format]
    R --> RD[ğŸŒŠ Streaming Responses<br/>Chunked real-time delivery]
    
    %% Background Services Layer
    NB --> S[âš¡ Background Task Queue<br/>Async operation management]
    S --> SA[ğŸ“‹ Task Scheduling<br/>Queue management]
    S --> SB[ğŸ”„ Task Execution<br/>Threaded processing]
    S --> SC[ğŸ“Š Progress Monitoring<br/>Status tracking]
    S --> SD[ğŸ”” Completion Handling<br/>Result notification]
    
    %% Persistence Layer
    D --> T[ğŸ’¾ Data Storage<br/>Session + conversation persistence]
    T --> TA[ğŸ—„ï¸ Session Database<br/>User sessions, preferences]
    T --> TB[ğŸ’¬ Conversation History<br/>Message storage + search]
    T --> TC[ğŸ“Š Analytics Storage<br/>Usage metrics, patterns]
    T --> TD[ğŸ”§ Task History<br/>Background operation logs]
    
    %% Notification System
    NBC --> U[ğŸ”” Notification Hub<br/>Multi-channel alerts]
    U --> UA[ğŸ–¥ï¸ Console Notifications<br/>CLI task completion]
    U --> UB[ğŸŒ Web Notifications<br/>Browser alerts]
    U --> UC[ğŸ“¡ API Callbacks<br/>Webhook notifications]
    U --> UD[ğŸ“± Push Notifications<br/>Mobile alerts]
    
    %% Configuration & Management
    V[âš™ï¸ Configuration Manager<br/>System settings]
    V --> VA[ğŸ‘¥ User Roles & Permissions<br/>Access control]
    V --> VB[ğŸ›ï¸ Feature Flags<br/>Component enablement]
    V --> VC[ğŸ“Š Resource Limits<br/>Memory, CPU, time constraints]
    V --> VD[ğŸ”’ Security Policies<br/>Command restrictions]
    
    %% External Integrations
    R --> W[ğŸ”— External Systems<br/>Third-party integrations]
    W --> WA[ğŸ“Š Analytics Platforms<br/>Usage tracking]
    W --> WB[ğŸ”” Alert Systems<br/>Monitoring integration]
    W --> WC[ğŸ’¾ External Storage<br/>Cloud persistence]
    W --> WD[ğŸ” Identity Providers<br/>SSO integration]
    
    %% Monitoring & Observability
    X[ğŸ“Š Monitoring Dashboard<br/>System health]
    X --> XA[ğŸ“ˆ Performance Metrics<br/>Response times, throughput]
    X --> XB[âŒ Error Tracking<br/>Failure analysis]
    X --> XC[ğŸ‘¥ User Analytics<br/>Behavior patterns]
    X --> XD[ğŸ” Debug Logging<br/>Troubleshooting info]
    
    %% Connect Configuration to Components
    V --> F
    V --> HA
    V --> NB
    V --> R
    
    %% Connect Monitoring to Key Components
    I --> X
    N --> X
    S --> X
    R --> X
    
    %% Key Features Box
    Y["ğŸ¯ Production-Ready Features<br/>âœ… Comprehensive error handling with recovery<br/>âœ… Pre-filtering security with role-based access<br/>âœ… Background tasks with progress tracking<br/>âœ… Smart context management with summarization<br/>âœ… Multiple output formats (raw/formatted/structured)<br/>âœ… Cross-interface command consistency<br/>âœ… Real-time streaming with WebSockets<br/>âœ… Session persistence with multi-user support<br/>âœ… Rich UI with tables and syntax highlighting<br/>âœ… Async operations with notification system<br/>âœ… Modular architecture - zero backend changes<br/>âœ… Production monitoring and observability"]
    
    %% Styling
    classDef new fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    classDef existing fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    classDef ui fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef security fill:#ffebee,stroke:#d32f2f,stroke-width:2px
    classDef async fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef storage fill:#f1f8e9,stroke:#689f38,stroke-width:2px
    classDef features fill:#fff8e1,stroke:#f57f17,stroke-width:3px
    
    class A,B,C,D,DA,DB,DC,E,EA,EAA,EAB,EAC,G,H,HA,HAA,HAB,HAC,HAD,N,NA,NAA,NAB,NAC,NAD,NB,NBA,NBB,NBC,NBD,O,OA,OB,OC,OD,S,SA,SB,SC,SD,U,UA,UB,UC,UD,V,VA,VB,VC,VD new
    class I,J,K,L,M existing
    class P,PA,PB,PC,PD,Q,QA,QB,QC,QD,R,RA,RB,RC,RD ui
    class F,FA,FB,FC,FD security
    class T,TA,TB,TC,TD,W,WA,WB,WC,WD,X,XA,XB,XC,XD storage
    class Y features